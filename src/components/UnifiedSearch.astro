---
/**
 * Unified FuseJS Search Component
 * Searches across: post, page
 * Auto-generated by PhantomWP
 * 
 * Customize by setting CSS variables:
 * --search-bg, --search-text, --search-border, --search-accent, --search-muted
 */
import postIndex from '../lib/search-index-post.json';
import pageIndex from '../lib/search-index-page.json';

interface Props {
  placeholder?: string;
  maxResults?: number;
  showType?: boolean;
  class?: string;
}

const { 
  placeholder = "Search all content...",
  maxResults = 10,
  showType = true,
  class: className = "",
} = Astro.props;

// Merge all indexes
const searchIndex = [...postIndex, ...pageIndex];

const searchId = 'search-unified-' + Math.random().toString(36).substr(2, 9);
const contentTypes = ["post","page"];
---

<div class={`fuse-search-container ${className}`} data-search-id={searchId}>
  <div class="search-input-wrapper">
    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.3-4.3"></path>
    </svg>
    <input 
      type="search" 
      id={searchId + '-input'}
      placeholder={placeholder}
      autocomplete="off"
      class="search-input"
    />
    <button 
      type="button" 
      id={searchId + '-clear'} 
      aria-label="Clear search"
      class="search-clear"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 6 6 18"></path>
        <path d="m6 6 12 12"></path>
      </svg>
    </button>
    
    <select id={searchId + '-filter'} class="search-filter">
      <option value="">All Types</option>
      <option value="post">Posts</option><option value="page">Pages</option>
    </select>
    
  </div>
  
  <div id={searchId + '-results'} class="search-results"></div>
</div>

<style>
  .fuse-search-container {
    --_bg: var(--search-bg, var(--color-surface, rgba(255, 255, 255, 0.95)));
    --_text: var(--search-text, var(--color-text, #1f2937));
    --_text-muted: var(--search-muted, var(--color-text-muted, #6b7280));
    --_border: var(--search-border, var(--color-border, #e5e7eb));
    --_accent: var(--search-accent, var(--color-accent, #3b82f6));
    --_accent-light: var(--search-accent-light, var(--color-accent-light, rgba(59, 130, 246, 0.1)));
    
    position: relative;
    width: 100%;
  }
  
  .search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .search-icon {
    position: absolute;
    left: 1rem;
    width: 1.25rem;
    height: 1.25rem;
    color: var(--_text-muted);
    pointer-events: none;
    z-index: 1;
  }
  
  .search-input {
    flex: 1;
    padding: 1rem 3rem 1rem 3rem;
    font-size: 1rem;
    background: var(--_bg);
    border: 2px solid var(--_border);
    border-radius: 0.75rem;
    color: var(--_text);
    transition: all 0.2s ease;
    backdrop-filter: blur(8px);
  }
  
  .search-input::placeholder {
    color: var(--_text-muted);
  }
  
  .search-input:focus {
    outline: none;
    border-color: var(--_accent);
    box-shadow: 0 0 0 4px var(--_accent-light);
  }
  
  /* Hide native browser clear button */
  .search-input::-webkit-search-cancel-button,
  .search-input::-webkit-search-decoration {
    -webkit-appearance: none;
    appearance: none;
  }
  
  .search-filter {
    padding: 1rem 1rem;
    font-size: 0.875rem;
    background: var(--_bg);
    border: 2px solid var(--_border);
    border-radius: 0.75rem;
    color: var(--_text);
    cursor: pointer;
    min-width: 120px;
    backdrop-filter: blur(8px);
  }
  
  .search-filter:focus {
    outline: none;
    border-color: var(--_accent);
  }
  
  .search-clear {
    position: absolute;
    right: 9rem;
    width: 1.5rem;
    height: 1.5rem;
    padding: 0.25rem;
    background: none;
    border: none;
    color: var(--_text-muted);
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 1;
  }
  
  .search-clear:hover {
    color: var(--_text);
  }
  
  .search-clear svg {
    width: 100%;
    height: 100%;
  }
  
  .search-results {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    right: 0;
    background: var(--_bg);
    border: 1px solid var(--_border);
    border-radius: 0.75rem;
    box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.25);
    max-height: 24rem;
    overflow-y: auto;
    z-index: 50;
    display: none;
    backdrop-filter: blur(12px);
  }
  
  .search-results.active {
    display: block;
  }
</style>

<script define:vars={{ searchIndex, searchId, maxResults, showType, contentTypes }}>
  import('https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.mjs').then(({ default: Fuse }) => {
    const container = document.querySelector(`[data-search-id="${searchId}"]`);
    const input = document.getElementById(searchId + '-input');
    const results = document.getElementById(searchId + '-results');
    const clearBtn = document.getElementById(searchId + '-clear');
    const filterSelect = document.getElementById(searchId + '-filter');
    
    if (!input || !results || !clearBtn) return;
    
    // Get computed CSS variable values for dynamic styling
    const styles = getComputedStyle(container);
    const textColor = styles.getPropertyValue('--_text').trim() || '#1f2937';
    const textMuted = styles.getPropertyValue('--_text-muted').trim() || '#6b7280';
    const borderColor = styles.getPropertyValue('--_border').trim() || '#e5e7eb';
    const accentColor = styles.getPropertyValue('--_accent').trim() || '#3b82f6';
    const accentLight = styles.getPropertyValue('--_accent-light').trim() || 'rgba(59, 130, 246, 0.1)';
    
    let currentFilter = '';
    let selectedIndex = -1;
    let currentResults = [];
    
    const fuse = new Fuse(searchIndex, {
      keys: [
        { name: 'title', weight: 0.4 },
        { name: 'excerpt', weight: 0.3 },
        { name: 'tags', weight: 0.15 },
        { name: 'categories', weight: 0.15 },
      ],
      threshold: 0.3,
      includeScore: true,
      includeMatches: true,
      minMatchCharLength: 2,
    });
    
    let debounceTimer;
    
    function highlightMatches(text, matches) {
      if (!matches || matches.length === 0) return text;
      const match = matches.find(m => m.key === 'title');
      if (!match) return text;
      
      let result = text;
      const indices = [...match.indices].sort((a, b) => b[0] - a[0]);
      for (const [start, end] of indices) {
        result = result.slice(0, start) + `<mark style="background: ${accentLight}; color: inherit; padding: 0 2px; border-radius: 2px;">` + result.slice(start, end + 1) + '</mark>' + result.slice(end + 1);
      }
      return result;
    }
    
    function formatDate(dateString) {
      try {
        return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      } catch { return ''; }
    }
    
    // Type color classes for badges
    const typeColorMap = {
      post: { bg: 'rgba(59, 130, 246, 0.15)', color: '#3b82f6' },
      page: { bg: 'rgba(34, 197, 94, 0.15)', color: '#22c55e' },
      product: { bg: 'rgba(168, 85, 247, 0.15)', color: '#a855f7' },
      default: { bg: accentLight, color: accentColor },
    };
    
    function getTypeColors(type) {
      return typeColorMap[type] || typeColorMap.default;
    }
    
    function updateSelection() {
      const items = results.querySelectorAll('[data-result-index]');
      items.forEach((item, i) => {
        if (i === selectedIndex) {
          item.style.background = accentLight;
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.style.background = 'transparent';
        }
      });
    }
    
    function renderResults(searchResults) {
      selectedIndex = -1;
      let filtered = searchResults;
      if (currentFilter) {
        filtered = searchResults.filter(r => r.item.type === currentFilter);
      }
      currentResults = filtered.slice(0, maxResults);
      
      if (currentResults.length === 0) {
        results.innerHTML = `<div style="padding: 2rem; text-align: center; color: ${textMuted};">No results found</div>`;
        results.classList.add('active');
        return;
      }
      
      const html = currentResults.map(({ item, matches }, index) => {
        const title = highlightMatches(item.title, matches);
        const typeColors = getTypeColors(item.type);
        const typeHtml = showType 
          ? `<span style="display: inline-flex; align-items: center; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; background: ${typeColors.bg}; color: ${typeColors.color}; text-transform: capitalize;">${item.type}</span>` 
          : '';
        
        return `
          <a href="${item.url}" data-result-index="${index}" style="display: block; padding: 1rem 1.25rem; border-bottom: 1px solid ${borderColor}; text-decoration: none; color: inherit; transition: background 0.15s ease; cursor: pointer;">
            <div style="font-weight: 600; color: ${textColor}; margin-bottom: 0.375rem; font-size: 1rem;">${title}</div>
            <p style="font-size: 0.875rem; color: ${textMuted}; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin: 0 0 0.5rem 0;">${item.excerpt}</p>
            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: ${textMuted};">
              ${typeHtml}
              <span>${formatDate(item.date)}</span>
            </div>
          </a>
        `;
      }).join('');
      
      results.innerHTML = html;
      results.classList.add('active');
      
      // Add hover handlers
      results.querySelectorAll('[data-result-index]').forEach((item, i) => {
        item.addEventListener('mouseenter', () => {
          selectedIndex = i;
          updateSelection();
        });
      });
    }
    
    function handleSearch() {
      const query = input.value.trim();
      clearBtn.style.opacity = query.length > 0 ? '1' : '0';
      
      if (query.length < 2) {
        results.classList.remove('active');
        currentResults = [];
        return;
      }
      
      renderResults(fuse.search(query));
    }
    
    input.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(handleSearch, 150);
    });
    
    input.addEventListener('focus', () => {
      if (input.value.trim().length >= 2) handleSearch();
    });
    
    if (filterSelect) {
      filterSelect.addEventListener('change', () => {
        currentFilter = filterSelect.value;
        if (input.value.trim().length >= 2) handleSearch();
      });
    }
    
    clearBtn.addEventListener('click', () => {
      input.value = '';
      results.classList.remove('active');
      clearBtn.style.opacity = '0';
      currentResults = [];
      input.focus();
    });
    
    document.addEventListener('click', (e) => {
      const searchContainer = document.querySelector(`[data-search-id="${searchId}"]`);
      if (searchContainer && !searchContainer.contains(e.target)) results.classList.remove('active');
    });
    
    input.addEventListener('keydown', (e) => {
      const isOpen = results.classList.contains('active');
      
      if (e.key === 'Escape') {
        results.classList.remove('active');
        input.blur();
        return;
      }
      
      if (!isOpen || currentResults.length === 0) return;
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);
        updateSelection();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection();
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        const selectedItem = currentResults[selectedIndex];
        if (selectedItem) {
          window.location.href = selectedItem.item.url;
        }
      }
    });
  });
</script>
